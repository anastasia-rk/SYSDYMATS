\documentclass[a4paper,11pt,twoside]{article}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages
\usepackage[final]{pdfpages}
\usepackage{verbatim}
\usepackage{inputenc}
\usepackage{graphicx} 
\usepackage{amsmath,amssymb,mathrsfs,amsfonts}
\usepackage{mathtools}
\usepackage{amsthm}
\usepackage{mathtools}
\usepackage{calrsfs}
\usepackage{graphicx}
\usepackage{subfig}
\usepackage{eucal}    
\usepackage{amssymb}  
\usepackage{pifont}
\usepackage{color} 
\usepackage{cancel}
\usepackage[toc,page]{appendix}
\usepackage{pgfplots}
\pgfplotsset{every axis/.append style={line width=0.5pt},label style={font=\scriptsize},tick label style={font=\scriptsize},x tick label style={/pgf/number format/.cd,fixed,precision=3, set thousands separator={}},z tick label style={/pgf/number format/.cd,fixed,precision=3, set thousands separator={}}}
\usetikzlibrary{shapes,shadows,arrows,backgrounds,patterns,positioning,automata,calc,decorations.markings,decorations.pathreplacing,bayesnet,arrows.meta}
%\usepackage{tikzexternal}
%\usepackage{tikz}
%\usepgfplotslibrary{external} 
%\tikzexternalize
\usepackage{varwidth}
\usepackage{lscape}
\usepackage{array} 
\usepackage[colorlinks=false,pdfborder={0 0 0}]{hyperref}
\usepackage{tabularx}
\usepackage{textcomp}
\usepackage{multicol} 
\usepackage{booktabs}
\usepackage{multirow}
\usepackage[font=small,labelfont=bf]{caption}                                                           
\usepackage{textcase}
\usepackage{bbm} 
\usepackage{fancyhdr}
\usepackage{enumitem}
\usepackage{soul}
%\usepackage[british]{babel}
\usepackage{wrapfig}
%\usepackage{glossaries}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\setlength{\parindent}{2em}
\setlength{\parskip}{0.5em}
\renewcommand{\baselinestretch}{1.2}
\usepackage[left=2cm, right=2cm, top=2.5cm, bottom=3cm, headheight=13.6pt]{geometry}
\allowdisplaybreaks 
% Bibliography
\usepackage[backend=bibtex,style=ieee,sorting=none]{biblatex} 
\bibliography{bibliography}
\renewcommand*{\bibfont}{\scriptsize}
\makeatletter
\newcommand*{\rom}[1]{\expandafter\@slowromancap\romannumeral #1@}
\newcommand{\ie}{\textit{i.e.} }
\newcommand{\eg}{\textit{e.g.} }
\makeatother
\newcommand\id{\ensuremath{\mathbbm{1}}} 
\DeclareMathOperator{\E}{\mathbb{E}}
\DeclareMathOperator{\eye}{\mathbb{I}}
\DeclareMathOperator{\zeros}{\mathbb{O}}
\DeclareMathOperator{\tr}{\textrm{tr}}
\DeclareMathOperator{\vvec}{\textrm{vec}}
\DeclareMathOperator{\ik}{\mathrm{k}}
\DeclareMathOperator{\ip}{\mathrm{p}}
\DeclareMathOperator{\inn}{\mathrm{n}}
\DeclareMathOperator{\im}{\mathrm{m}}
\DeclareMathOperator{\td}{\mathrm{t}}
\DeclareMathOperator{\kd}{\mathrm{k}}
\DeclareMathOperator{\T}{\mathrm{T}}
\DeclareMathOperator{\K}{\mathrm{K}}
\DeclareMathOperator{\rk}{\mathrm{rk}}
\DeclareMathOperator{\vc}{\mathrm{vec}}
\DeclareSymbolFontAlphabet{\mathcal} {symbols}
\DeclareSymbolFont{symbols}{OMS}{cm}{m}{n}
\DeclareMathAlphabet{\mathbfit}{OML}{cmm}{b}{it}

% Number equations
%\numberwithin{equation}{section}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Theorems
\newtheoremstyle{mytheoremstyle} % name
{.5em}                    % Space above
{.8em}                    % Space below
{\itshape}                % Body font
{1em}                           % Indent amount
{\bfseries}                   % Theorem head font
{:}                          % Punctuation after theorem head
{.5em}                       % Space after theorem head
{}  % Theorem head spec (can be left empty, meaning ‘normal’)

\theoremstyle{mytheoremstyle}
\newtheorem{theorem}{Theorem}[section]
\newtheorem{remark}{Remark}[section]
\newtheorem{assumption}{Assumption}[section]
\newtheorem{lemma}{Lemma}[section]
\newtheorem{condition}{Condition}[section]
\newtheorem{definition}{Definition}[section]
\newtheorem{property}{Property}[section]
\newtheorem{corollary}{Corollary}[section]
\renewcommand\qedsymbol{$\blacksquare$}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Nomenclature
\usepackage[intoc]{nomencl}
\makenomenclature

%\usepackage[ruled,chapter]{algorithm}
%\usepackage{float}

%\usepackage{algorithmic}
%\algsetup{linenosize=\scriptsize}
%\usepackage{etoolbox}
%\AtBeginEnvironment{algorithmic}{\scriptsize}
%\renewcommand{\thealgorithm}{\thechapter.\arabic{algorithm}} 
%\usepackage{chngcntr}
%\counterwithin{algorithm}{section}

% correct bad hyphenation here
\hyphenation{op-tical net-works semi-conduc-tor}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Captions
%\newcommand{\xLanguage}{british}          % <-- Added this command
%
%\usepackage[\xLanguage]{babel}             % <-- Implemented here
%
%\expandafter\addto\csname captions\xLanguage\endcsname{% <-- and here
%	\renewcommand{\tableshortname}{Table}%
%	\renewcommand{\figureshortname}{Figure}%
%}
%
%\captionsetup[table]{format=plain,indention=1.15cm,justification=justified}
%\captionsetup[figure]{format=plain,indention=1.25cm,justification=justified}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[explicit]{titlesec}
\usepackage{titletoc}
%\titleformat{\section}[block]{\normalfont\Large\rm\filright\bfseries}{\thesection}{1em}{#1}
%\titlecontents{chapter}[1.5em]{}{\scshape\contentslabel{2.3em}}{}{\titlerule*[1pc]{}\contentspage}
%\definecolor{gray75}{gray}{0.5}
%\newcommand{\hsp}{\hspace{20pt}}
%\titleformat{\chapter}[hang]{\huge\scshape\filright\bfseries}{\color{gray75}\thechapter}{20pt}{\begin{tabular}[t]{@{\color{gray75}\vrule width 2pt\hsp}p{0.85\textwidth}}\raggedright#1\end{tabular}}
%\titleformat{name=\chapter,numberless}[display]{}{}{0pt}{\normalfont\huge\bfseries #1} % format for numberless chapters
%\titleformat{\subsection}[block]{\normalfont\large\rm\filright\bfseries}{\thesubsection}{1em}{#1}
%\renewcommand{\sectionmark}[1]{\markright{\thesection ~ \ #1}}
%%\renewcommand{\chaptermark}[1]{\markboth{\chaptername\ \thechapter ~ \ #1}{}} 
%\pagestyle{fancy}
%%\fancyhf{}
%\fancyhead[RO,LE]{\thepage}
%\fancyhead[RE]{\itshape \nouppercase \rightmark}      % chaptertitle left
%\fancyhead[LO]{\itshape \nouppercase \leftmark}       % sectiontitle right
%\renewcommand{\headrulewidth}{0.5pt} 				   % no rule
%\cfoot{}
\interfootnotelinepenalty=10000

\title{Direct estimation of the dynamical model from batch data from multiple experiments}

\begin{document}
	\maketitle
\section{Direct estimation of surface coefficients}
\par Orthogonalisation and forward search are applied to all datasets to identify significant model terms prior to parameter estimation as described in \cite{Wei2008}.\\
\par Model structure for an individual dataset:
\begin{equation}
\underbrace{\mathbfit{y}^k}_{\T\times 1} = \underbrace{\Phi^k}_{\T \times N} \underbrace{\theta^k}_{N \times 1},
\end{equation}
where $\T$ is the length of time-series, $k = 1,\dots, K$ is the dataset index, $N$ is identified number of significant terms.
Model structure for $K$ datasets:
\begin{equation}\label{eq:batchtimeser}
\underbrace{\bar{\mathbf{Y}}}_{\T K\times 1} = \underbrace{\bar{\Phi}}_{\T K \times NK} \underbrace{\bar{\Theta}}_{NK \times 1},
\end{equation}
where the block matrices have the following structure:
\begin{equation}
\underbrace{\bar{\mathbf{Y}}}_{\T K\times 1} = \left[\begin{array}{c} 
\underbrace{\mathbfit{y}^1}_{\T\times 1} \\
\underbrace{\mathbfit{y}^2}_{\T\times 1} \\
\vdots \\
\underbrace{\mathbfit{y}^K}_{\T\times 1}
\end{array}\right]; \quad 
\underbrace{\bar{\Phi}}_{\T K \times NK} = \left[\begin{array}{cccc} 
\underbrace{\Phi^1}_{\T \times N} & \dots & \dots & \zeros \\
\zeros & \underbrace{\Phi^2}_{\T \times N} & \dots & \zeros \\
\vdots & \vdots & \vdots & \vdots  \\
\zeros & \dots & \dots & \underbrace{\Phi^K}_{\T \times N}
\end{array}\right]; \quad 
\underbrace{\bar{\Theta}}_{NK \times 1} = \left[\begin{array}{c} 
\underbrace{\theta^1}_{N \times 1} \\
\underbrace{\theta^2}_{N \times 1} \\
\vdots \\
\underbrace{\theta^K}_{N \times 1}
\end{array}\right].
\end{equation}
\par The relationship of the design parameters known from the experiments and the internal parameters of NARMAX model  is defined by the following linear function:
\begin{equation}
\underbrace{\Theta}_{N \times K} = \underbrace{B}_{N \times L} \underbrace{A}_{L \times K},
\end{equation}
where $A$ is the matrix where each row is a function of the vector of design parameters. The example structure is
\begin{equation}
A = \left[\begin{array}{cccccc}
\eye_{K \times 1} & L_{K \times 1} & D_{K \times 1} & L D_{K \times 1} &  L^{2}_{K \times 1} & D^{2}_{K \times 1} 
\end{array}\right]^{\top},
\end{equation} 
and where $B$ denotes the matrix of unknown coefficients of a hypersurface of order $L$ that maps a point in external parameter space, $\xi^k = (L_k, D_k)$, onto the point in the space of internal parameters, $\theta^k$.
In can be seen that $\bar{\Theta} = \text{vec}(\Theta)$, then
\begin{equation}
\underbrace{\bar{\Theta}}_{NK \times 1} = \text{vec}\left(\underbrace{B}_{N \times L} \underbrace{A}_{L \times K}\right).
\end{equation}
This vectorisation can be obtained using Kronecker product:
\begin{equation}
\text{vec}\left(\underbrace{B}_{N \times L} \underbrace{A}_{L \times K}\right) = (\underbrace{A^{\top}}_{K \times L} \otimes \underbrace{\eye}_{N \times N}) \underbrace{\text{vec}(B)}_{NL \times 1}.
\end{equation}
Denoting the result of Kronecker product as $\underbrace{\mathbf{Kr}}_{NK \times NL} \triangleq (\underbrace{A^{\top}}_{K \times L} \otimes \underbrace{\eye}_{N \times N})$ and vectorised coefficient matrix as $\underbrace{\bar{\mathbf{B}}}_{NL \times 1} \triangleq \text{vec}(B)$  yields the following:
\begin{equation}\label{eq:BtoTheta}
\underbrace{\bar{\Theta}}_{NK \times 1} = \underbrace{\mathbf{Kr}}_{KN \times NL} \underbrace{\bar{\mathbf{B}}}_{NL \times 1}.
\end{equation}
Substituting the above expression into \eqref{eq:batchtimeser} renders an expression that directly links the design parameters and the timeseries data
\begin{equation}\label{eq:BtoY}
\underbrace{\bar{\mathbf{Y}}}_{\T K\times 1} = \underbrace{\bar{\Phi}}_{\T K \times NK} \underbrace{\mathbf{Kr}}_{KN \times NL} \underbrace{\bar{\mathbf{B}}}_{NL \times 1},
\end{equation}
where $\bar{\mathbf{B}}$ is the unknown vector and all other factors are known form the experiments or defined prior to structure identification. 
\par The representation \eqref{eq:BtoY} allows estimating the coefficients in  $\bar{\mathbf{B}}$ directly from the timeseries data bypassing the intermediate estimation of the internal coefficients in NARMAX model. It must be noted, however, that its not increasing the dimension of the matrix that guarantees identifiability of the system but its rank. The following condition must be satisfied:
\begin{equation}\label{eq:rankcond}
\rk(\bar{\Phi}\mathbf{Kr}) \geq NL.
\end{equation}
The rank of the linear system \eqref{eq:BtoY} satisfies the following:
\begin{equation}
\rk (\bar{\Phi}\mathbf{Kr}) \leq \min\left(\rk(\bar{\Phi}), \rk(\mathbf{Kr})\right),
\end{equation}
where the rank of Kronecker product can be found as
\begin{equation}
\rk(\mathbf{Kr}) = \rk(\underbrace{A^{\top}}_{K \times L})\rk(\underbrace{\eye}_{N \times N}),
\end{equation}
where the first factor is $\rk(A^{\top}) = \min\{K, L\}$ (note that all rows and columns in the matrix $A$ are known to be independent ``by design"), and where second factor equals $N$. Given the above two expressions, it is evident that regardless of the length of the available time series, the identifiability of the system depends on the number of experiments, $K$, and the selected order of the hypersurface fitted to the points in the design parameter space, $L-1$. Moreover, if insufficient number of datapoints are available ($K < L$), the condition \eqref{eq:rankcond} can not be satisfied rendering the system \eqref{eq:BtoY} unidentifiable.
\section{Estimation results for joint datasets}
\par To test this approach, 8 out of 10 datasets are used for model identification and two remaining datasets (C3 and C8) are used for validation. The surface coefficients estimated via ordinary least squares from system \eqref{eq:BtoY} are presented in Table \ref{tab:Betas_direct_all}. The estimation results are similar to those obtained in the two-stage process in \cite{Wei2008}. The output generated by the identified models for C3 and C8 are compared with the outputs in Figure \ref{fig:Betas_direct_all}. RMSEs for C3 and C8 are equal to 1.97 and 12.08, respectively.
\begin{table}[!h]
	\centering
	\caption{Estimated polynomial coefficients for the sample length 2000.}\label{tab:Betas_direct_all}
	\small
	\input{Betas_direct_C.tex}
\end{table}

\begin{figure}[!h]
	\centering
	\subfloat[C3]{\input{Gen_y_direct_C3_size_all.tikz}\label{fig:c3all}}\\
	\subfloat[C8]{\input{Gen_y_direct_C8_size_all.tikz}\label{fig:c8all}}
	\caption{Samples of the output obtained experimentally and the output generated by the model identified from all datasets.}\label{fig:Betas_direct_all}
\end{figure}
\printbibliography

\end{document}